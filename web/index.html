<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>ComfyUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="user.css" />
    <link rel="stylesheet" type="text/css" href="materialdesignicons.min.css" />
    <script type="module" crossorigin src="./assets/index-Hblmz8kc.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-BpidjGOo.css">
    <style>
      #ai-agent-container {
        position: fixed;
        top: 50px;
        right: 0;
        width: 350px;
        height: calc(100vh - 100px);
        background-color: #262626;
        border-left: 1px solid #444;
        color: #f0f0f0;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease;
        overflow: hidden;
      }
      #ai-agent-header {
        padding: 10px;
        background-color: #333;
        border-bottom: 1px solid #444;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #ai-agent-header h3 {
        margin: 0;
        font-size: 1rem;
      }
      #ai-agent-header-buttons {
        display: flex;
        gap: 8px;
      }
      .ai-agent-button {
        background: none;
        border: none;
        color: #f0f0f0;
        cursor: pointer;
        padding: 0 4px;
      }
      .ai-agent-button:hover {
        color: #ffffff;
      }
      #ai-agent-toggle-button {
        position: fixed;
        top: 60px;
        right: 0;
        background-color: #3a5e8c;
        color: white;
        border: none;
        border-radius: 4px 0 0 4px;
        padding: 8px;
        cursor: pointer;
        z-index: 999;
        transform: translateX(0);
        transition: transform 0.3s ease;
      }
      #ai-agent-toggle-button:hover {
        background-color: #4a6e9c;
      }
      .ai-agent-hidden {
        transform: translateX(100%);
      }
      #ai-agent-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
      }
      #ai-agent-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .ai-agent-message {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 4px;
        max-width: 85%;
        word-break: break-word;
      }
      .ai-agent-message.user {
        background-color: #3a5e8c;
        align-self: flex-end;
        margin-left: auto;
      }
      .ai-agent-message.ai {
        background-color: #424242;
        align-self: flex-start;
      }
      #ai-agent-input-container {
        display: flex;
        margin-top: auto;
      }
      #ai-agent-input {
        flex: 1;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #444;
        background-color: #333;
        color: #f0f0f0;
        resize: none;
      }
      #ai-agent-send {
        margin-left: 8px;
        padding: 8px 16px;
        background-color: #3a5e8c;
        border: none;
        border-radius: 4px;
        color: #f0f0f0;
        cursor: pointer;
      }
      #ai-agent-send:hover {
        background-color: #4a6e9c;
      }
      /* 노드 스토어 버튼 스타일 */
      #node-store-fixed-button {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        background-color: #3a5e8c;
        color: white;
        border: none;
        border-radius: 0 0 4px 4px;
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }
      #node-store-fixed-button:hover {
        background-color: #4a6e9c;
      }
    </style>
  </head>
  <body class="litegraph grid">
    <div id="vue-app"></div>
    
    
    <!-- AI Agent 토글 버튼 -->
    <button id="ai-agent-toggle-button">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 3H14C16.2091 3 18 4.79086 18 7V17C18 19.2091 16.2091 21 14 21H10C7.79086 21 6 19.2091 6 17V7C6 4.79086 7.79086 3 10 3Z" stroke="currentColor" stroke-width="2"/>
        <path d="M13 7L17 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M13 12L17 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M13 17L17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    
    <!-- AI Agent Container -->
    <div id="ai-agent-container">
      <div id="ai-agent-header">
        <h3>ComfyUI AI Agent</h3>
        <div id="ai-agent-header-buttons">
          <button class="ai-agent-button" id="ai-agent-close">×</button>
        </div>
      </div>
      <div id="ai-agent-content">
        <div id="ai-agent-messages"></div>
        <div id="ai-agent-input-container">
          <textarea id="ai-agent-input" rows="2" placeholder=""></textarea>
          <button id="ai-agent-send">Send</button>
        </div>
      </div>
    </div>

    <script>
      // 고정된 노드 스토어 버튼 구현
      document.addEventListener("DOMContentLoaded", function() {
        // 노드 스토어 버튼 기능
        const nodeStoreButton = document.getElementById("node-store-fixed-button");
        nodeStoreButton.addEventListener("click", function() {
          alert("노드 스토어를 준비 중입니다!");
        });
      });

      // AI Agent 기능 구현
      document.addEventListener("DOMContentLoaded", function() {
        const container = document.getElementById("ai-agent-container");
        const toggleButton = document.getElementById("ai-agent-toggle-button");
        const closeButton = document.getElementById("ai-agent-close");
        const messages = document.getElementById("ai-agent-messages");
        const input = document.getElementById("ai-agent-input");
        const send = document.getElementById("ai-agent-send");
        
        // 세션 ID 생성
        const sessionId = 'session_' + Date.now();
        
        // 토글 기능
        toggleButton.addEventListener("click", function() {
          container.classList.toggle("ai-agent-hidden");
          if (!container.classList.contains("ai-agent-hidden")) {
            // 대화창이 열릴 때 시작 메시지 표시
            if (messages.children.length === 0) {
              addMessage("안녕하세요! ComfyUI AI Agent입니다. 노드 관리나 워크플로우 생성을 도와드릴까요?", "ai");
            }
          }
        });
        
        // 닫기 버튼
        closeButton.addEventListener("click", function() {
          container.classList.add("ai-agent-hidden");
          toggleButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 3H14C16.2091 3 18 4.79086 18 7V17C18 19.2091 16.2091 21 14 21H10C7.79086 21 6 19.2091 6 17V7C6 4.79086 7.79086 3 10 3Z" stroke="currentColor" stroke-width="2"/>
              <path d="M13 7L17 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M13 12L17 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M13 17L17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          `;
        });
        
        // 메시지 전송 기능
        send.addEventListener("click", sendMessage);
        input.addEventListener("keypress", function(e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        
        function sendMessage() {
          const text = input.value.trim();
          if (!text) return;
          
          console.log("메시지 전송 시작:", text);
          
          try {
            // 워크플로우 데이터 가져오기
            let workflowJson = "{}";
            try {
              const app = window.app;
              if (app && app.graph) {
                const workflow = app.graph.serialize();
                workflowJson = JSON.stringify(workflow || {});
                console.log("워크플로우 데이터 가져옴:", workflowJson.substring(0, 100) + "...");
              } else {
                console.warn("워크플로우 데이터를 가져올 수 없습니다: app.graph가 없습니다");
              }
            } catch (e) {
              console.warn("워크플로우 데이터를 가져올 수 없습니다:", e);
            }
            
            // 사용자 메시지 추가
            addMessage(text, "user");
            
            // API 호출
            fetch("/api/aiagent", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                message: text,
                workflow: workflowJson,
                session_id: sessionId
              }),
            })
            .then(response => {
              console.log("서버 응답 상태:", response.status);
              return response.json();
            })
            .then(data => {
              console.log("서버 응답 데이터:", data);
              if (data.response) {
                addMessage(data.response, "ai");
              } else if (data.error) {
                addMessage("오류: " + data.error, "ai");
                console.error("서버 오류:", data.error);
              }
            })
            .catch(error => {
              console.error("API 호출 오류:", error);
              addMessage("서버 오류가 발생했습니다. 나중에 다시 시도해주세요.", "ai");
            });
            
            // 입력 필드 초기화
            input.value = "";
          } catch (error) {
            console.error("메시지 전송 중 오류 발생:", error);
            addMessage("메시지 전송 중 오류가 발생했습니다.", "ai");
          }
        }
        
        function addMessage(text, sender) {
          const messageElement = document.createElement("div");
          messageElement.classList.add("ai-agent-message", sender);
          messageElement.textContent = text;
          messages.appendChild(messageElement);
          messages.scrollTop = messages.scrollHeight;
        }
      });

      // ComfyAgent 클라이언트 모델 통합
      document.addEventListener("DOMContentLoaded", function() {
        // 1초 후에 실행 (ComfyUI가 초기화된 후에 실행하기 위함)
        setTimeout(loadClientModels, 1000);
      });

      // 클라이언트 모델 로드 함수
      async function loadClientModels() {
        try {
          // ComfyAgent 서버에서 클라이언트 모델 목록 가져오기
          const response = await fetch('/comfyui/client_models?type=checkpoints');
          if (!response.ok) {
            console.error('클라이언트 모델 가져오기 실패:', response.statusText);
            return;
          }
          
          const data = await response.json();
          console.log('클라이언트 모델 데이터:', data);
          
          if (data.models && data.models.length > 0) {
            // ComfyUI의 모델 리스트 찾기
            const modelDropdowns = document.querySelectorAll('select[data-comfyui-model-type="checkpoints"]');
            
            if (modelDropdowns.length > 0) {
              // 각 모델 드롭다운에 클라이언트 모델 추가
              modelDropdowns.forEach(dropdown => {
                // 기존 모델 유지
                const existingOptions = Array.from(dropdown.options).map(opt => opt.value);
                
                // 새 모델 추가
                data.models.forEach(model => {
                  if (!existingOptions.includes(model.name)) {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name + ' [Client]';
                    option.dataset.clientId = model.client_id;
                    dropdown.appendChild(option);
                  }
                });
              });
              
              console.log('클라이언트 모델이 드롭다운에 추가되었습니다');
            } else {
              console.warn('모델 드롭다운을 찾을 수 없습니다. ComfyUI가 아직 초기화되지 않았을 수 있습니다');
              // 다시 시도
              setTimeout(loadClientModels, 2000);
            }
          } else {
            console.log('사용 가능한 클라이언트 모델이 없습니다');
          }
        } catch (error) {
          console.error('클라이언트 모델 로드 중 오류:', error);
        }
      }
    </script>
  </body>
</html>
